#!/usr/bin/env ruby

require "optparse"

require_relative "../lib/hutils"
require_relative "../lib/hutils/mdash"

Thread.abort_on_exception = true

colors = $stdout.tty?

opts = OptionParser.new do |opts|
  opts.banner = "Usage: mdash [options] <file> ..."
  opts.on("-h", "--help", "Show this help string") { |h|
    if h
      puts(opts.help)
      exit(0)
    end
  }
  opts.on("--no-color", "Disable colors") { |c| colors = false }
end
opts.parse!

tracker = Hutils::Mdash::MetricTracker.new
visualizer = Hutils::Mdash::MetricVisualizer.new(
  colors: colors,
  tracker: tracker
)

Thread.start do
  ARGF.each_line do |line|
    messages = Hutils::Parser.new(line).parse
    messages.each do |message|
      tracker.process(message)
    end
  end
  tracker.eof = true
end

visualizer.run
